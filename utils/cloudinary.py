from io import BytesIO
from pprint import pprint
import cv2
import base64
import numpy as np
import cloudinary
import cloudinary.uploader
import cloudinary.api
from PIL import Image
from fastapi import HTTPException
import os

CLOUD_NAME=os.environ.get("CLOUD_NAME")
API_KEY=os.environ.get("API_KEY")
API_SECRET=os.environ.get("AIP_SECRET")

cloudinary.config(
    cloud_name=CLOUD_NAME,
    api_key=API_KEY,
    api_secret=API_SECRET,
)

def getClondinaryUrl(img_text: str):
    img_text_sprited = img_text.split(",")
    if len(img_text_sprited) != 2:
        raise HTTPException(status_code=400,detail="image text uncollect")

    img_text_data = img_text_sprited[-1]
    #バイナリデータ <- base64でエンコードされたデータ
    img_binary = base64.b64decode(img_text_data)
    temp = np.array(Image.open(BytesIO(img_binary)))

    img_prop = []
    for x in temp:
        tmp = []
        for y in x:
            tmp.append(255 - y[3]) # Aの値を抽出して白黒反転
        img_prop.append(tmp)
    img_prop = np.array(img_prop).astype("uint8")
    res = cloudinary.uploader.upload(file=img_prop)
    pprint(res)

getClondinaryUrl("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAAAXNSR0IArs4c6QAAEpFJREFUeF7tXU2yLjcNdXZAMWJG2EGyAmDEkCW8ZAWBFQArCKwgZMQ4s8yAFRBW8GADVHYAJXJVT9fXP5It2e7uc6tSSeVzy/KRTsuSf/qjhD8gAASqCHwEbIAAEKgjAILAO4BAAwEQBO4BBEAQ+AAQGEMAEWQMNzz1EARAkIcYGsMcQwAEGcMNTz0EARDkIYbGMMcQAEHGcMNTD0EABHmIoTHMMQRAkDHcNE/94qXR3zSN0eZMBECQGLv8NaVEBCFy/DKmC0hdgQAIEoPyaoL8/oWMiFbO9gRBnAF9EfdfMb2KjiBMRuryDyklIgv+nBAAQZyAzMQwQeh/R2Ms+wJBnO0ZbTxndS8hjnIPeqvzXzTGkiDIeZxdJNp4zupeQtyfU0rvhKZ/f0nYo5SXU6wVEStqHEfKBUH8zfI+pfRxJjYSZ8o5frcwYvkjdrDESMMdPOxQ1eSUhzqKnvaAIIHmBEH8wc0JsmLaI/v8bUrpj/7DeqbEOxDktBXr1RGEPBeJehB/r06QE9cA8qQ5eopFriH7XNFfkDueJ/ZOBGF0yUFoPWDXqvIOgqwuLZ/nyUEaXZ0g5Bj0j6zi7CZKXub9OqX0WZD9WCwIEgTw1QkiYcnf3PI3iibfpJS+WxBZ8qoSbTVZEc1Wrt4HueN5Yu9EEEKXowkn7iXEo6dgJxBkFSnP82hnje5GEDnloGnXDqKAIM5OulPcXQnCmLamXVG5Sk6QFRsI8xwEEcSJVXcnCMGUJ8016Lwc+QSCPMGuThRoi3kKkK1ql0SIy8MzSfWOtzmqWEF0eQpBZG5SKwtLiGemKDsIQrqjihVAkqcRRELYq3jNrEjvcNYdfQa45Fkin0wQGVXov2tVr5FossNZZZ8jOp/lmYdoA4K8NkQtqlgS+BOmWBZ9D3HFM9UAQcp2yStR1ErrdLsIcuLGzTO93qAVCFIHK3d0LUl2EUSSeiZ/MrjP/ZuCIG0bl6ZcvTPmJxCERgXbOvAXIOpAtEy5dhEEpV6dLU2tQBA9XOT4X2UXMtTykl0VpR3VMz2CF2wJgtiNVtrfJYmyc1V7FzHtKF7kCRBkzFC9KdcuR0Ula8ye1adAkHFAS1UuPmsib1ZcuWgHgozbs/gkCDIPaCmaSKkrMcYti/P2fCVhpfGcVT9KXIskKzHGJXLObrHSeM6qHymuRJSVGO86zXikMTyUWmk8D32vIKOXwEeOYcdhrcjxbJcNgsSYoHT9qHYv14xGeeFgRZ8z+h7/LAgSY6ISQagnjxOLPY3xQZ0eQobfQRADWIam+Yp2PvWJvGAa9/QaDNVrCoL0EBr7vbTlY1V+AIKM2az4FAjiCKYQ1doTJW9ZibjEDqVeR5uCII5gKglCzSKjCQjiaFMQxBFMA0G4ab7y7bEtBWshjjYFQRzBFKLkdwp7GHuXZnN5HgUBvlfscd9g7xkvxn3uL5VzEMvR1/wjODPfOPFM1B99lBcEiSHr6MGl/O1vIZgcyewXp1p3hnlMA2NQD5AKggSA6nDLYZ6bWFfEZ3b1/iOl9EkDlkf5zKMGG8OFolTpoKMY529xS0l45Fx86UhxPjgrURdCHtPVqPFitLmP1JEcpDb6kZKwlSCt7fpMTNJv5lLvS1oXBIkx22gOUtMmjyaaN7lmT1Yr1xjNf2IQ3SQVBIkB3psgrGVeUWpVunqJeu3jQpapXAx6B0kFQWKMEUUQ0lYbTWrl2VauwYSjNvT3uHWP3B1AkOsRpBZNqPwq/0oLkKXPZfMzXL7ddSNLjCUmpYIgkwBWHvdM0lsaymhSyhlq51KkTPncSEEgBsFDpIIgMYZYRZBSNJEJfI0gRAq6Y1hOoXJyIEnHBccx7HBYKBxRTDo4keTnhc9g1xJwkKOC+NUjCG+i+/jla7an1Okjk/QeeWrVqa9TSp8VHi5dgHd1v+hhpP79CkBwRYUrOPRm5P+uDXTF2e8WyKunWKxLydn5N81F29T2UXuteky5AkFqb8Te2Oj30lxb89xsm9UEaS348VhKOQXOjnQsfXeCSOfIk9JZEpwQQXor4d+klL4UisrogIqVwgOuQBCeTpEzcI5B/+apF82r3ynGSk00WzSUoprNoiNIixj8ImCsZD70r5TS5y+aywu2V+Hige1SGVchiAYUeiOWKjelZ6MdIpIgtY2FtQpVb/s6yrkN77oTQeQwezeuR0cTzpu8na80rt7eqR4WSMofSBAecs85vk8p/SlgzxETxDNS5cWKfCqlyYnyNrXSryZiP6LNXSNIbrweUbwrXt4EmU2oe+c98n1cj3B+zSCfQhAZUei/W5v2PKKKF0FKyfhIVKJpGK8f0fj5U9ZRU0GN712izdMIIo0ibzgsGas3t28Z2IMgpUW/EXLUogfbnn/3zpcuQYCekk8mCGPD21VqUWUkiZ0lSMmpR/RoraxL2yOSVJgCgrwGphZVrG9udnDrc6TNTDJuqeTlCToiSYEkIMhbUGqLcBZnZ2ezvPW9plQ0opIs0kUuDva2nlh0781ULvs7CFI3XW3NQVPxsUSQ2hTPQshe5ODrR/Mxlewv2zyeJCBI+902+lb/zcseqN46AznjFymlHwk1ZooDJVJLopWO4ZbOnct2jyYJCNIP/qUpV2+RrjfFqlWWZpyxRw4eqeY6oHyaNhrN+uge3gIE0RvIUlmqTbFq+8Uo0lCBYPTAl5YceRGgV9qVkeSRJAFB9ASpJb8lx2HH4t94GlMqJc86Xqny1pKpyUMkKjKCzupqQ/uA1iCI3QilKVf+JmaC0FSMpjTyVCT36OFslsgh131Gtro/cq0EBLEThJ9oTbnyrR2yFw9ikLxS/72igDUPydGZXQAdR3vTkyDIHPAlJ6WoIfc9eUaMFjktxLNOsyRKjyIJCDJHkFpeEhExalMk+v8WcpSiyHcppU8NUDyGJCCIwSsqTVtbyf/Z+RiNtfeRnKPWR37S0EKyxyTuIIjVRT+0Ly3ylaTNrG1IeZ7kqEU+i66PKAGDIHaC1CIGv4HJcf6SUvqJEG15O5c08iZHLZfprYvkut2eJCCIniC1PVOlzyzzVhOPXCSKHKzb7Lfab70tBQTREaS2cbH2ARt2Grpmh65F5T/rPqvRvWC6Uf3QKu/DGkVyGZZpmkXPLW1BkDbsvelU7Wl2OiaEXJijZzRTLsvWllnneZ8RecQvbhlJRoCYNcZVnp+d2tAKOr+NrWfLS5FDuwg4gm/e32gUuB1JQJC37lSrTmne+lIa75otHW3ldjWZeV4wMu2xEqX3TUOtvFudJwFBPph9dDpVc5wSQaht3k8eGUqXda+wk1cUoTF6fCdeS8jQdiuADx2Ag/DaFnRKsH82IZ+dpIRxLTG27sydUO/No9rDVJo+pSzrKr1G/rI2TyeId9SQhmsRhCs/X2XJcW5467Ru1nHkJsvZaZ3EdlbW7LiGn38qQVrbQ0YT1NwI3EdPXu37J7MRbMQpZjYxlvqT21msJe4R/d2feRJBKOzzdKoEpPfbWksQ0iX/2OYOcjAm2iO5Wmf0Sv61/bm2uztBSuXV0jSG3m6jx11rBuHV9B7xahGk95yrIwhh3gQplawv43eXUdTgDRpSsLhIJ+QIYjn+mg9zx9zde5rF+Va+WNqbehpMHtf0bgRp5RYSxUhicD/5ufTciqX9WnznFp1d52O6O0gio4jXAmUpkhxPkjsRREOOlYlijyB53pHfXyVJsrpUmpebvRy5RJIdLwB1yLkDQTTEIEBWRI0ceLndRP6W68yfI8if35Xg5vp5YlciCY3bi4Rq59c0vDpBep+IXhkxSniXVtNLhG7ZIS+Vaq4+1di+1ybH1pskMkKSLrWXRE/P0N/vRBAyIP3R9nIqk0ZUpqzGyAkyukNXOquno7bGExlFuN+8j+OiyNUJIhNZq/OuaC9X00fJUaoCrXKkaAfOp1vH+eNxCq3w2oV9MEFKVwGVTiK2VJs9+Tcy7NyBPYsFVMX7dXap3nH+eJxCI1Y8+BnvvV555WtFJMkPU430yZGe/136nv2qqaPJXUAQE1zmxt+mlH6VPTXjCDvWEkaO5PJiLU8PNcCNEE8jd6oNCDIFX/fh1lpH9+FKgx0kycdR8xvLLgY5vCPJQQqCIKNu2n9Ou9bRl/S2xexxYGufvfxnlBieOY11TKr2IIgKpqFG2rfukPDK5dVRb+I8avGahYUYVHaXVcfajTCjeIQ8B4KEwFq8eT3CeWdKx9aR54SXDl+SxbujVy1sWsejag+CqGAyNSptQiQBM8l5S4FVJOntWmAdaZH284DjAyYjeDUGQbyQ/CAnf9PyGkgUQajn6MSd5PeOB+/e1uNvSSTp7piWEnNyHNp3FEmQEkk8dsnSrt6fVr6QxeDdkhg8OEQQP460NiHWdvX69f6DpNKbfiT3ITlfKj7d4HVWxBsHN3kgiA+UpSmOjBi1O7J8en8tJa8sWSOJ9vhAZF4VgcuQTBBkCLY3D/VuQlxJkNp0S1NWLd3LJadS/04pvctGf2sfuvXgfHy/K0VTRWICjUx3ugo0GmgPXLWihqxKRRcDZsYa8iwIMgdrb2rF0i1XAM1p9Ha61bssoUWOUmEhr9LdOg8BQebcsTe1YunaK4DmtCk/XduWQq2pulb7q1XdStOw2/rRbQcW4WmZzJKj1KZQmiuAIlWunQOv9dk6q6KNmpHjWSYbBBmD2rpZsHfDyZgWtqc0JNGu1ZS2nVx6S0kNShDE5mTUuuRovatC+RlrydWuXf2JVq5hvTDBevGE5ziWygJB7HDnb0+SoHnzri71ypFp9lFZkm1rBLWjfMgTIIjNEDOOsYMgtWkVkaG0hURDdEbsEdUsEERPkNoURYth73shek36LVvnNGQhYeaDPY+oZmmN2zfJ/VvMRA9CJ3qxUHN4qWTv0XGBIPf3efUIPUqbUQQh3cjJ6aaQkbItPVMiSS8necSqOiKIjiPy02T8hHXbiOdaiCZaaIsHPB5rJPF4aejQ39gKBOmD7+UIMwThs9z5fbYl7WfOZ9Q2K9b8pHQ4jHXtI3uBFiBI30ilEqn1VkQ5jdFUitjJ6N+0e5buG279zZAil1srRpQi5u3zEBDETpDRxb7WajpPmYgIPTKwxqQHLfBFXNKtvRFypgrWR/6AFiBI3whe2yrkajpFEd4oaJmS8E0hmrMd/ZG1W9RIkifvpYXT2/jVbQYy6w2N571uR9TsharlFHRQid7W3h8a7cGm2QpvTe57fR71OwjSN0dOEOttgNqKE2lCBCCbkNPJqVRfy7gWPWLLaMhaWDGK035SMgjSB1B+4Ylbl3CTiTWvSWimT5xgM0H6Gu1p0TqO+5+U0o8ztW7hW7cYRLC/lNZAuBLF0YFU0JCBVb3q5Wq8IKkZq6ZaF2y6efEgiA7DUiKqe/L1VIkvPbAuMlr7im6vufkEBIm2wkHyNQ5RU1dGi11n06Og7N2CcvlDVIggetfRnKmQeUSpFLvzbLp+pLaWrZfH5f3r8gOw2XK6dc0ZtCvZM9tNppUPFFCbgl7evy4/gECjt0RTkkr/WFexTzh6GwFZqRQ8uuMgQr9hmSDIMHRDD96VIARGno9cvRDxfwODIEN+PvzQnQnCoHBkHQbppAdBkPXW2HE2ff0ob9IjCLLekCDIesyHewRBhqEbfpAJcos5+jAKF3kQBFlvKBBkPebDPYIgw9ANP8gLjrfYijGMwkUeBEHWG+r9y6nB3q0h6zVDj28QAEHWOwWvpt9iIW09fGt7BEHW4k29ye0qwH89/qYeYSATXC6NQRAXGNcIAUHW4Cx7kQRBqXc9/qYeQRATXC6N5cY+VLJcII0TAoLEYVuTDIKsx3y4RxBkGLqpB3mxEBFkCsb4h0GQeIxLPTBBUOrdg7+6VxBEDZVrQ3l8FzZwhdZXGIzji6dWGkq9WqQ2twNB9hgApd49uJt7BUHMkLk8AIK4wBgvBASJx7jUgyz1YrFwjw1UvYIgKphCGuFcSAisvkJBEF88LdKwFmJBa1NbEGQT8CklnAvZh726ZxBEDZV7Q5wLcYfUXyAI4o+pViIIokVqYzsQZB/4WCzch726ZxBEDZV7Q5R63SH1FwiC+GOqlYht71qkNrYDQfaBD4Lsw17dMwiihiqkIdZCQmD1EwqC+GE5Iulun2QbweDoZ0CQo80D5XYjAILstgD6PxoBEORo80C53QiAILstgP6PRgAEOdo8UG43AiDIbgug/6MRAEGONg+U240ACLLbAuj/aARAkKPNA+V2IwCC7LYA+j8aARDkaPNAud0IgCC7LYD+j0YABDnaPFBuNwIgyG4LoP+jEQBBjjYPlNuNAAiy2wLo/2gEQJCjzQPldiMAguy2APo/GgEQ5GjzQLndCPwPKIJjBSxaVOAAAAAASUVORK5CYII=")


